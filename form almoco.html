<html>
  <head>
    <link
      type="text/css"
      rel="stylesheet"
      href="/style-guide/css/fluig-style-guide.min.css"
    />
    <script
      type="text/javascript"
      src="/portal/resources/js/jquery/jquery.js"
    ></script>
    <script
      type="text/javascript"
      src="/portal/resources/js/jquery/jquery-ui.min.js"
    ></script>
    <script
      type="text/javascript"
      src="/portal/resources/js/mustache/mustache-min.js"
    ></script>
    <script
      type="text/javascript"
      src="/style-guide/js/fluig-style-guide.min.js"
      charset="utf-8"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/webdesk/vcXMLRPC.js"></script>
  </head>

  <body>
    <div class="fluig-style-guide">
      <form name="form" role="form">
        <div class="panel" style="background-color: #ff6400; color: #fff">
          <div class="panel-heading">
            <i
              class="flaticon flaticon-restaurant-menu icon-md"
              aria-hidden="true"
            ></i>
            Enquete do almoço
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="form-group col-md-6">
                <i
                  class="fluigicon fluigicon-user icon-md"
                  aria-hidden="true"
                ></i>
                <label for="cpf">Nome</label>
                <input type="text" name="nome" id="nome" class="form-control" />
              </div>
            </div>
            <div class="row">
              <div class="form-group col-md-6">
                <i
                  class="flaticon flaticon-restaurant icon-md"
                  aria-hidden="true"
                ></i>
                <label for="nascimento">Restaurante</label>
                <select
                  name="restaurante"
                  id="restaurante"
                  class="form-control"
                  dataset="Restaurantes"
                  datasetkey="Nome"
                  datasetvalue="Nome"
                  addBlankLine="true"
                ></select>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="container">
        <div class="row">
          <p>Resultado até o momento:</p>
        </div>
        <div class="row" id="info">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </body>

  <script>
    //Definir dataset como uma variável global
    var dataset;

    // Função para obter os dados do dataset no Fluig
    function obterDadosDataset() {
      // Substitua 'DSFormAula' pelo nome do seu dataset no Fluig
      dataset = DatasetFactory.getDataset("DSFormAula", null, null, null);
      var dados = {
        Outback: 0,
        Quentinha: 0,
        "Leve Mix": 0,
        Bistrô: 0,
      };

      // Verificar se o dataset existe antes de prosseguir
      if (dataset && dataset.values) {
        for (var i = 0; i < dataset.values.length; i++) {
          var restauranteSelecionado = dataset.values[i].restaurante;

          // Verificar se o restaurante existe nas opções esperadas
          if (dados.hasOwnProperty(restauranteSelecionado)) {
            // Incrementar o contador para o restaurante selecionado
            dados[restauranteSelecionado]++;
          } else {
            console.log("Restaurante não reconhecido:", restauranteSelecionado);
          }
        }
      } else {
        console.log("Dataset não encontrado ou sem valores.");
      }

      return dados;
    }

    // Configuração do gráfico
    var ctx = document.getElementById("chart").getContext("2d");
    var myChart;

    // Função para inicializar e atualizar o gráfico
    function inicializarGrafico() {
      var dados = obterDadosDataset();

      // Verificar se há dados antes de criar o gráfico
      if (
        dataset &&
        Object.values(dados).reduce((acc, curr) => acc + curr, 0) > 0
      ) {
        // Destruir o gráfico anterior se existir
        if (myChart) {
          myChart.destroy();
        }

        // Criar um novo gráfico
        myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: Object.keys(dados),
            datasets: [
              {
                label: "Quantidade de Votos",
                data: Object.values(dados),
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      } else {
        // Se não houver dados ou dataset não existe, exibir mensagem
        console.log("Chegou aqui");
        document.getElementById("info").innerHTML =
          "<p>Sem dados até o momento</p>";
      }
    }

    // Chamar a função para inicializar o gráfico ao carregar a página
    inicializarGrafico();
  </script>
</html>
